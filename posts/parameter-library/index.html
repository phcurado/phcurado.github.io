<!doctype html><html class="not-ready text-sm lg:text-base" style=--bg:#faf6f1 lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Serializing and Deserializing external data in Elixir - phcurado</title><meta name=theme-color><meta name=description content="Since I started using Elixir I always felt that the ecosystem was missing a good library for serializing and deserializing external data. We already have some libraries in this area but it always feels that the existing ones are missing some features. For instance, when serializing parameters a library should have the following features:
Schema definition to shape your data. Type definition to convert the external data field to internal types."><meta name=author content><link rel="preload stylesheet" as=style href=https://phcurado.github.io/main.min.css><link rel=preload as=image href=https://phcurado.github.io/theme.png><link rel=preload as=image href=https://phcurado.github.io/github.svg><link rel=preload as=image href=https://phcurado.github.io/rss.svg><link rel=icon href=https://phcurado.github.io/favicon.ico><link rel=apple-touch-icon href=https://phcurado.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.110.0"><meta property="og:title" content="Serializing and Deserializing external data in Elixir"><meta property="og:description" content="Since I started using Elixir I always felt that the ecosystem was missing a good library for serializing and deserializing external data. We already have some libraries in this area but it always feels that the existing ones are missing some features. For instance, when serializing parameters a library should have the following features:
Schema definition to shape your data. Type definition to convert the external data field to internal types."><meta property="og:type" content="article"><meta property="og:url" content="https://phcurado.github.io/posts/parameter-library/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-21T10:11:21+02:00"><meta property="article:modified_time" content="2022-01-21T10:11:21+02:00"><meta itemprop=name content="Serializing and Deserializing external data in Elixir"><meta itemprop=description content="Since I started using Elixir I always felt that the ecosystem was missing a good library for serializing and deserializing external data. We already have some libraries in this area but it always feels that the existing ones are missing some features. For instance, when serializing parameters a library should have the following features:
Schema definition to shape your data. Type definition to convert the external data field to internal types."><meta itemprop=datePublished content="2022-01-21T10:11:21+02:00"><meta itemprop=dateModified content="2022-01-21T10:11:21+02:00"><meta itemprop=wordCount content="1079"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Serializing and Deserializing external data in Elixir"><meta name=twitter:description content="Since I started using Elixir I always felt that the ecosystem was missing a good library for serializing and deserializing external data. We already have some libraries in this area but it always feels that the existing ones are missing some features. For instance, when serializing parameters a library should have the following features:
Schema definition to shape your data. Type definition to convert the external data field to internal types."></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href=https://phcurado.github.io/>phcurado</a>
<a class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.svg)_left_center/cover_no-repeat] dark:invert dark:[background-position:right]"></a></div><a class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"></a>
<script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg=`"#faf6f1"`.replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"><a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/phcurado target=_blank></a>
<a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./rss.svg) href=https://phcurado.github.io/index.xml target=_blank></a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"><article><header class=mb-20><h1 class="!my-0 pb-2.5">Serializing and Deserializing external data in Elixir</h1><div class="text-sm opacity-60"><time>Jan 21, 2022</time></div></header><section><p>Since I started using Elixir I always felt that the ecosystem was missing a good library for serializing and deserializing external data. We already have some libraries in this area but it always feels that the existing ones are missing some features. For instance, when serializing parameters a library should have the following features:</p><ul><li>Schema definition to shape your data.</li><li>Type definition to convert the external data field to internal types.</li><li>Common validation methods.</li><li>Function for serializing and deserializing the data by the given schema.</li><li>Flexible and extensible.</li></ul><p>In this article, I will dive into how commonly this is done in most of the Elixir apps and how we can improve that.</p><h2 id=external-data>External data</h2><p>External data means any type of data that comes into your application and you don&rsquo;t completely know about it. This data can be unpredictable, maybe coming with unknown values or even wrong types. This can potentially harm your system if you don&rsquo;t parse it correctly. One of the common examples of dealing with external data is when building an API. The controller us usually built like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>MyAppWeb.SuperController</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>use</span> <span style=color:#a6e22e>MyAppWeb</span>, <span style=color:#e6db74>:controller</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> index(conn, _params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    supers <span style=color:#f92672>=</span> <span style=color:#a6e22e>Context</span><span style=color:#f92672>.</span>list_users()
</span></span><span style=display:flex><span>    render(conn, <span style=color:#e6db74>:index</span>, <span style=color:#e6db74>users</span>: users)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> create(conn, %{<span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>=&gt;</span> user_params}) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    with {<span style=color:#e6db74>:ok</span>, %<span style=color:#a6e22e>User</span>{} <span style=color:#f92672>=</span> user} <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>Context</span><span style=color:#f92672>.</span>create_user(user_params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      conn
</span></span><span style=display:flex><span>      <span style=color:#f92672>|&gt;</span> put_status(<span style=color:#e6db74>:created</span>)
</span></span><span style=display:flex><span>      <span style=color:#f92672>|&gt;</span> put_resp_header(<span style=color:#e6db74>&#34;location&#34;</span>, <span style=color:#e6db74>~p&#34;/api/users/</span><span style=color:#e6db74>#{</span>user<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>      <span style=color:#f92672>|&gt;</span> render(<span style=color:#e6db74>:show</span>, <span style=color:#e6db74>user</span>: user)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>From the controller create action, <code>user_params</code> comes from external data.</p><p>This approach looks fine for most cases but there are two small problems:</p><ul><li>We infer that the database schema will be almost the same as the API request/response.</li><li>We are not validating the data that are coming into our system on the <strong>create</strong> function in the controller.</li></ul><p>We may rely on that for validating data we should use the changesets from <code>Ecto</code> and this is a correct statement, we should validate the data before saving it on the database. But what if our API changes over time but the database schema doesn&rsquo;t?
These validations will start to get trickier and using the same DB schema with Changesets starts to become more troublesome to solve complex cases when dealing with external parameters.</p><p>To outcome this problem it&rsquo;s possible to use <a href=https://hexdocs.pm/ecto/embedded-schemas.html>Embedded Schemas</a> and create a different schema for your API. This will solve most of the problems described above.
The reason this is enough is that we control and shape our API schema, this is internal to our application so we can define its boundaries. Now, what would happen if we would like to apply the same pattern when integrating into an external API?</p><h2 id=integrating-with-external-api>Integrating with External API</h2><p>Let&rsquo;s say that your Elixir application needs to integrate with an external payment provider. This payment provider is not famous and while testing its endpoints, we noticed some inconsistencies in its API docs. This situation is very common when integrating with third-party softwares.
For this fictional API, this is a POST request example for charging the user:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># POST /charge-user</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Request</span>
</span></span><span style=display:flex><span>curl -v -X POST https://api-payment-fictional.com/charge-user <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;detail&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;invoiceNumber&#34;: &#34;ABC123&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;currencyCode&#34;: &#34;USD&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;amount&#34;: &#34;500&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;discount&#34;: &#34;10%&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;user&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;firstName&#34;: &#34;John&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;lastName&#34;: &#34;Doe&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;phones&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;countryCode&#34;: &#34;001&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;number&#34;: &#34;123456789&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;phoneType&#34;: &#34;PERSONAL&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Response</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;id&#34;: &#34;1234&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;status&#34;: &#34;NEW&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;detail&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;amount&#34;: &#34;500.00&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;billed&#34;: &#34;450.00&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;currencyCode&#34;: &#34;USD&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><p>This would be my approaches for dealing with this data:</p><ul><li>Create a client module to have the request/response implementation of this payment provider endpoint.</li><li>Create helper functions to shape this data into elixir internal types and do proper validation for the fields.</li></ul><p>How do we properly shape and validate this data? By using schema definitions! Again we can use <a href=https://hexdocs.pm/ecto/embedded-schemas.html>Embedded Schemas</a> for that, let&rsquo;s give a try:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#75715e># Request</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>MyApp.ChargeRequest</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Ecto.Schema</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>import</span> <span style=color:#a6e22e>Ecto.Changeset</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@primary_key</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  embedded_schema <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    embeds_one <span style=color:#e6db74>:details</span>, <span style=color:#a6e22e>Detail</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      field <span style=color:#e6db74>:invoiceNumber</span>, <span style=color:#e6db74>:boolean</span>
</span></span><span style=display:flex><span>      field <span style=color:#e6db74>:currencyCode</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>      field <span style=color:#e6db74>:amount</span>, <span style=color:#e6db74>:decimal</span>
</span></span><span style=display:flex><span>      field <span style=color:#e6db74>:discount</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>      embeds_one <span style=color:#e6db74>:user</span>, <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        field <span style=color:#e6db74>:firstName</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>        field <span style=color:#e6db74>:lastName</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>        embeds_many <span style=color:#e6db74>:phones</span>, <span style=color:#a6e22e>Phone</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>          field <span style=color:#e6db74>:countryCode</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>          field <span style=color:#e6db74>:number</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>          field <span style=color:#e6db74>:phoneType</span>, <span style=color:#a6e22e>Ecto.Enum</span>, <span style=color:#e6db74>values</span>: [<span style=color:#e6db74>&#34;PERSONAL&#34;</span>, <span style=color:#e6db74>&#34;WORK&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> load(params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    params
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> changeset()
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> apply_action(<span style=color:#e6db74>:update</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> changeset(params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>%</span>__MODULE__{}
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast_embed(<span style=color:#e6db74>:detail</span>, <span style=color:#e6db74>required</span>: <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>with</span>: <span style=color:#f92672>&amp;</span>detail_changeset<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defp</span> detail_changeset(schema, params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    schema
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast(params, [<span style=color:#e6db74>:invoiceNumber</span>, <span style=color:#e6db74>:currencyCode</span>, <span style=color:#e6db74>:amount</span>, <span style=color:#e6db74>:discount</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> validate_required([<span style=color:#e6db74>:invoiceNumber</span>, <span style=color:#e6db74>:currencyCode</span>, <span style=color:#e6db74>:amount</span>, <span style=color:#e6db74>:discount</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast_embed(<span style=color:#e6db74>:user</span>, <span style=color:#e6db74>required</span>: <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>with</span>: <span style=color:#f92672>&amp;</span>user_changeset<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defp</span> user_changeset(schema, params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    schema
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast(params, [<span style=color:#e6db74>:firstName</span>, <span style=color:#e6db74>:lastName</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> validate_required([<span style=color:#e6db74>:firstName</span>, <span style=color:#e6db74>:lastName</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast_embed(<span style=color:#e6db74>:phones</span>, <span style=color:#e6db74>required</span>: <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>with</span>: <span style=color:#f92672>&amp;</span>phone_changeset<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defp</span> phone_changeset(schema, params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    schema
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast(params, [<span style=color:#e6db74>:countryCode</span>, <span style=color:#e6db74>:number</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> validate_required([<span style=color:#e6db74>:countryCode</span>, <span style=color:#e6db74>:number</span>])
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#75715e># Response</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>MyApp.ChargeResponse</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Ecto.Schema</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>import</span> <span style=color:#a6e22e>Ecto.Changeset</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@primary_key</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  embedded_schema <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    field <span style=color:#e6db74>:id</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>    field <span style=color:#e6db74>:status</span>, <span style=color:#a6e22e>Ecto.Enum</span>, <span style=color:#e6db74>values</span>: [<span style=color:#e6db74>&#34;NEW&#34;</span>, <span style=color:#e6db74>&#34;CHARGED&#34;</span>, <span style=color:#e6db74>&#34;CANCELED&#34;</span>]
</span></span><span style=display:flex><span>    embeds_one <span style=color:#e6db74>:detail</span>, <span style=color:#a6e22e>Detail</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      field <span style=color:#e6db74>:amount</span>, <span style=color:#e6db74>:decimal</span>
</span></span><span style=display:flex><span>      field <span style=color:#e6db74>:currencyCode</span>, <span style=color:#e6db74>:string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> load(params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    params
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> changeset()
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> apply_action(<span style=color:#e6db74>:update</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> changeset(params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>%</span>__MODULE__{}
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast(params, [<span style=color:#e6db74>:id</span>, <span style=color:#e6db74>:status</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> validate_required([<span style=color:#e6db74>:id</span>, <span style=color:#e6db74>:status</span>, <span style=color:#e6db74>:amount</span>, <span style=color:#e6db74>:discount</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast_embed(<span style=color:#e6db74>:detail</span>, <span style=color:#e6db74>required</span>: <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>with</span>: <span style=color:#f92672>&amp;</span>detail_changeset<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defp</span> detail_changeset(schema, params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    schema
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> cast(params, [<span style=color:#e6db74>:amount</span>, <span style=color:#e6db74>:currencyCode</span>])
</span></span><span style=display:flex><span>    <span style=color:#f92672>|&gt;</span> validate_required([<span style=color:#e6db74>:amount</span>, <span style=color:#e6db74>:currencyCode</span>])
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Now as an example, the client module using (Tesla)[https://github.com/elixir-tesla/tesla] as HTTP client:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=display:flex><span><span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>MyApp.PaymentAPI</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Tesla</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>alias</span> <span style=color:#a6e22e>MyApp.ChargeRequest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>alias</span> <span style=color:#a6e22e>MyApp.ChargeResponse</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  plug <span style=color:#a6e22e>Tesla.Middleware.BaseUrl</span>, <span style=color:#e6db74>&#34;https://api-payment-fictional.com/&#34;</span>
</span></span><span style=display:flex><span>  plug <span style=color:#a6e22e>Tesla.Middleware.JSON</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> charge_user(params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    with {<span style=color:#e6db74>:ok</span>, data} <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ChargeRequest</span><span style=color:#f92672>.</span>load(params) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      post(<span style=color:#e6db74>&#34;/charge-user&#34;</span>, data)
</span></span><span style=display:flex><span>      <span style=color:#f92672>|&gt;</span> parse_charge_user_response()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defp</span> parse_charge_user_response({<span style=color:#e6db74>:ok</span>, response}) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ChargeResponse</span><span style=color:#f92672>.</span>load(response<span style=color:#f92672>.</span>body)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defp</span> parse_charge_user_response({<span style=color:#e6db74>:error</span>, _error} <span style=color:#f92672>=</span> error) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    error
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And now the API module is ready to be used in your other modules for requesting the charge user endpoint and successfully parsing both the request and responses. It&rsquo;s always important to parse the data that comes from external APIs because this data will be used in the application logic. For this case, parsing the data incorrectly could mean that you are not charging the user with the correct amount or you are not successfully validating if a user was already charged or not.</p><p>Now let&rsquo;s show some cons of this current implementation:</p><ul><li>The schemas are very verbose, if you implement more endpoints you will have more verbose schemas.</li><li>Schemas are loaded into structs, this is not ideal in APIs where you can omit some fields when doing the request. Using structs the omitted fields on params will be evaluated as <code>nil</code>.</li><li>To follow the APIs JSON keys, the schemas have camelCase fields which under the hood will create a struct with the same case. This is not common to do in Elixir.</li></ul><p>Next, let&rsquo;s see how we can improve this using the <a href=https://github.com/phcurado/parameter>Parameter</a> library specially designed for this problem.</p></section></article></main><footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2023
<a class=link href=https://phcurado.github.io/>phcurado</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>▷ Paper 6</a></footer></body></html>